# クマ出没予測AIシステム — TODO（全面見直し版）

> **更新日**: 2026-02-14
> **方針転換**: プロトタイプ対象地域を **静岡県 → 東北地方（秋田・岩手・福島）** に変更
> **理由**: プレゼンで訴求している被害データと対象地域を一致させる / 被害件数が圧倒的に多い地域の方がデータ量・説得力ともに有利

---

## 0. 全体方針：1から考え直すべきポイント

### 0.1 なぜ東北に変えるのか

- プレゼン資料では東北（秋田56名、岩手34名、福島20名）の被害を前面に出しているのに、システムは静岡を対象にしていた → **ストーリーの一貫性が破綻している**
- 静岡の目撃データは790件/2.5年。東北3県なら秋田だけで数倍のデータが見込める → **モデル学習のデータ量問題が緩和される**
- 「サイバー大学生 × 衛星データ × 熊」の意味づけとして、被害が最も深刻な地域をターゲットにする方が自然

### 0.2 現行の根本的な問題点（地域変更とは別に解決すべき）

| # | 問題 | 影響度 | 詳細 |
|---|---|---|---|
| P1 | **衛星データの空間解像度が粗い** | 中 | NDVI/LST: ~5km、GSMaP: ~10km。ただしこれらは「いつ危ないか」の時間弁別に使い、「どこが危ないか」の空間弁別はDEM/FNF（~1km）と距離特徴量で担う。**予測メッシュは1km維持** |
| P2 | **極端なクラス不均衡への対処が未設計** | 高 | メッシュ×月のサンプルに対して正例が少ない。**ネガティブサンプリング（正例1:負例10〜20）** で学習データの正例率5〜10%に調整する |
| P3 | **負例（non-event）生成戦略が未定義** | 高 | 二値分類なのに「出没しなかった」データの作り方が未定。ここが学習の肝 |
| P4 | **季節性とNDVIの交絡が未検証** | 中 | EDAのNDVI相関 r=0.693は季節性を拾っているだけの可能性。月ダミーを入れた上でのNDVIの追加予測力が不明 |
| P5 | **目撃データの出典・ライセンスが不明** | 中 | tukinowaguma_source1120.csvの出典がどこにも書かれていない |
| P6 | **日次補正の設計が抽象的** | 低 | 「ベースリスク×日次補正」の数式・算出方法が未定義 |

---

## 1. データ取得（東北3県）

### 1.1 目撃データの収集

- [ ] **秋田県クマダス CSV取得**
  - URL: https://ckan.pref.akita.lg.jp/dataset/050008_shizenhogoka_003
  - 形式: CSV（緯度経度あり）
  - 期間: 2022年度〜（運用開始: 2024年7月）
  - 備考: ツキノワグマ以外（イノシシ・シカ）も含まれるのでフィルタリング必要

- [ ] **岩手県オープンデータ確認**
  - URL: https://www.pref.iwate.jp/opendata/1000081/index.html
  - 確認事項: CSVダウンロード可否、緯度経度の有無
  - フォールバック: 岩手県自然保護課への問い合わせ or PDF/マップからの手動CSV化

- [ ] **福島県データ取得**
  - URL: https://www.pref.fukushima.lg.jp/sec/16035b/tukinowaguma-mokugeki.html
  - 形式: Excel (.xlsx)、複数年度あり（R4〜R7）
  - 確認事項: 緯度経度が含まれるか（住所ベースの可能性あり → ジオコーディング必要かも）

- [ ] **データの統一フォーマット化**
  - 既存のスキーマ（sighting_id, date, lat, lon, type, source...）に統一
  - 3県のデータを1つのCSVにマージ
  - sourceカラムで出典を明記

- [ ] **出典・ライセンスの記録**
  - 各データの利用規約を確認
  - docs/ にデータ出典一覧を作成

### 1.2 JAXA衛星データの再取得

- [ ] **BBOX（対象範囲）の再定義**
  - 東北3県をカバーする範囲（概算）:
    ```
    秋田: [139.5, 39.2, 141.0, 40.9]
    岩手: [141.0, 39.2, 142.1, 40.7]
    福島: [140.2, 36.8, 142.0, 37.9]
    ```
  - → 統合BBOX: **[139.5, 36.8, 142.1, 40.9]**（かなり広い）
  - **要検討**: 3県全域は広すぎるので、被害集中エリアに絞る方が現実的かも

- [ ] **config.py の更新**
  - BBOX を東北用に変更
  - DATE_START/END を目撃データに合わせて調整
  - SIGHTINGS_CSV のパスを更新

- [ ] **衛星データの役割分担を明確にする** ← P1対応
  - **予測メッシュは1km × 1kmを維持**（5kmでは実用上粗すぎる）
  - 衛星データの役割を2層に分離:
    - **空間弁別（どこが危ないか）**: DEM標高/傾斜(~1km), FNF森林(~1km), 市街地・河川距離(任意精度)
    - **時間弁別（いつ危ないか）**: NDVI(~5km), LST(~5km), GSMaP(~10km) → 同じ5kmブロック内の1kmメッシュには同一値が入るが、季節コンテキスト情報として機能
  - 補完検討: Sentinel-2(10m) や ppu引き上げで高解像度化できるか試す（余裕があれば）

- [ ] **fetch_jaxa.py を東北用に実行**
  - BBOX変更後、全コレクション（NDVI, DEM, FNF, GSMaP, LST, Landcover）を再取得
  - 東北は静岡より範囲が広いのでデータサイズに注意
  - ssl_verify=False の扱いを検討

### 1.3 その他データ

- [ ] **気象データ（アメダス）の東北対応**
  - 秋田・岩手・福島のアメダス観測点を特定
  - ブナ・ナラの豊凶と降水量の関係に注目（秋の凶作→人里出没の因果）

- [ ] **DEM（標高）の確認**
  - 東北は静岡と地形が異なる（奥羽山脈、北上山地）
  - クマの生息標高帯も違う可能性があるので事前調査

---

## 2. モデル設計の見直し

### 2.1 クラス不均衡対策 ← P2対応

- [ ] **ネガティブサンプリング方式を採用**
  - 全メッシュ×全月を使うのではなく、正例1件に対して負例を**10〜20件**抽出
  - これにより学習データの正例率を**5〜10%**に調整（LightGBMが十分学習できる水準）
  - 参考: 不正検知・希少事象の予測で広く使われる標準的手法
  - 加えてLightGBMの`scale_pos_weight`も併用

- [ ] **正例率の試算**（1kmメッシュ × 月次の場合）
  - 東北3県の1kmメッシュ数を概算
  - 目撃データ件数から、ネガティブサンプリング後の学習データサイズを算出

### 2.2 負例生成戦略 ← P3対応

- [ ] **負例生成ルールの策定**
  - 案1: 同じ月の目撃メッシュ「以外」からランダムサンプリング
  - 案2: 目撃地点から一定距離（例: 10km以上）離れたメッシュを負例
  - 案3: 「明らかにクマがいない場所」（市街地中心部、海岸沿い）を負例
  - **推奨**: 案1 + 案3のハイブリッド。森林域からの負例もバランスよく含める

### 2.3 特徴量の再設計

- [ ] **季節性とNDVIの交絡を切り分ける** ← P4対応
  - 月ダミー変数を投入した上でのNDVI重要度を検証
  - 偏相関係数の算出: NDVIと目撃件数の相関から月の影響を除去
  - **もし月を入れるとNDVIの重要度が消える場合**: 発表で正直に報告し、「衛星データは空間的な生息適地判定に貢献」とストーリーを修正

- [ ] **東北特有の特徴量を検討**
  - ブナ帯の分布（東北はブナ林が豊富でクマの食料源）
  - 積雪深データ（冬眠開始・終了の推定に有用）
  - 人口密度の変化（過疎化→緩衝地帯喪失のプロキシ）

- [ ] **特徴量一覧の更新**
  ```
  [空間・静的]
  F1: DEM標高
  F2: DEM傾斜角
  F3: FNF森林/非森林
  F4: Landcover土地被覆分類
  F5: 最寄り市街地までの距離
  F6: 河川までの距離

  [時系列・動的]
  F7: NDVI値（月次）
  F8: NDVI前月差分
  F9: LST地表面温度（月次）
  F10: GSMaP降水量（月次）
  F11: 月（1-12, カテゴリ）

  [履歴]
  F12: 同メッシュ過去出没回数
  F13: 近傍メッシュの直近出没数
  ```

### 2.4 予測単位の再定義

- [ ] **1km × 1km メッシュ × 月次** をベースラインとする
  - 1kmなら実用的な危険区域の特定が可能
  - 空間弁別: DEM/FNF/距離特徴量（1km以下の解像度）
  - 時間弁別: NDVI/LST/GSMaP（5-10km解像度だが季節コンテキストとして機能）
  - クラス不均衡: ネガティブサンプリングで対処（全メッシュを学習に使わない）

- [ ] **評価指標の目標値**
  - AUC-ROC ≥ 0.7
  - Recall ≥ 0.8（安全重視: 見逃しを最小化）
  - 空間的妥当性: 秋田県内の出没多発地域との整合性チェック

---

## 3. 実装TODO（優先度順）

### Phase 0: 環境整備・データ準備（最優先）

- [ ] **3-0-1**: 東北3県の目撃データを入手・統合CSV化
- [ ] **3-0-2**: config.py を東北用に更新（BBOX, DATE_START/END）
- [ ] **3-0-3**: fetch_jaxa.py で東北エリアの衛星データ取得
- [ ] **3-0-4**: 取得データの確認（shape, 値域, NaN率）

### Phase 1: EDA（東北版）

- [ ] **3-1-1**: 東北版 EDAノートブック作成
  - 目撃の月別・地域別分布
  - 衛星データとの相関分析（静岡と同じ手法）
  - **追加**: 月ダミーを統制した偏相関分析
- [ ] **3-1-2**: EDA結果をdocs/にまとめる

### Phase 2: 特徴量エンジニアリング

- [ ] **3-2-1**: メッシュ分割スクリプト（1kmメッシュ）
- [ ] **3-2-2**: 各メッシュに衛星データ特徴量を付与
- [ ] **3-2-3**: 負例生成スクリプト
- [ ] **3-2-4**: 学習用テーブル（features.parquet）生成

### Phase 3: モデル学習

- [ ] **3-3-1**: LightGBM学習スクリプト（scale_pos_weight対応）
- [ ] **3-3-2**: 評価スクリプト（AUC, Recall, 混同行列, 特徴量重要度）
- [ ] **3-3-3**: **衛星データあり/なしのBefore/After比較**
  - 「衛星データが効いている」ことの定量的な証拠
  - 月+標高だけのモデル vs 衛星データ追加モデルのAUC比較

### Phase 4: API & UI

- [ ] **3-4-1**: FastAPI推論エンドポイント
- [ ] **3-4-2**: Folium地図UI（東北3県表示、メッシュ塗り分け）
- [ ] **3-4-3**: 統合テスト

### Phase 5: 発表準備

- [ ] **3-5-1**: プレゼン資料の更新（対象地域を東北に統一）
- [ ] **3-5-2**: デモ動画 or ライブデモの準備
- [ ] **3-5-3**: 想定質問への回答準備
  - 「なぜ東北？」→ 被害最多、当事者性
  - 「衛星データは本当に効いているか？」→ Before/After比較
  - 「サイバー大学生がやる意味は？」→ 通信制×地方在住×当事者

---

## 4. 要件定義の修正ポイント

以下の箇所を `requirements_bear_prediction.md` で修正する:

- [ ] **1.1 目的**: 静岡県 → 東北3県（秋田・岩手・福島）
- [ ] **1.2 背景**: 東北の被害データに差し替え
- [ ] **1.3 対象種**: 同じ（ツキノワグマ）
- [ ] **2.1 ハイブリッド方式**: まずは月次ベースリスクのみでMVP、日次補正は将来対応と明記
- [ ] **3.1 衛星データ**: 空間解像度の制約と、衛星データの役割分担（空間弁別 vs 時間弁別）を追記
- [ ] **3.2 クマ目撃情報**: 東北3県のデータソースに差し替え
- [ ] **4.2 予測単位**: 1km維持、日次 → 月次（MVP）、ネガティブサンプリング方式を追記
- [ ] **4.3 特徴量設計**: 東北特有の特徴量を追加
- [ ] **4.4 ターゲット変数**: クラス不均衡への対処方針を追記
- [ ] **5. アーキテクチャ**: 変更なし（構造は同じ）
- [ ] **7. ディレクトリ構成**: data/raw/sightings に東北3県のデータ
- [ ] **付録A**: 東北のデータソースURLに更新

---

## 5. リスクと判断ポイント

| リスク | 影響 | 対策 |
|---|---|---|
| 岩手県データに緯度経度がない | 目撃データが2県分に減る | 住所→ジオコーディング変換 or 秋田+福島の2県で進行 |
| 東北BBOXが広すぎてJAXA APIのデータ取得に時間がかかる | 開発遅延 | 秋田県に絞ってプロトタイプ→成功後に拡大 |
| NDVI/LSTが5kmで同一値になる1kmメッシュが多数存在 | モデルの空間弁別力 | 空間弁別はDEM/FNF/距離特徴量に委ね、衛星データは時間弁別に使う役割分担で対処 |
| 月次予測だと「日次のリアルタイム警告」が実現できない | コンセプトとの乖離 | MVP=月次リスクマップ、将来=日次補正と段階を明示 |
| NDVI相関が季節性の擬似相関 | 発表の説得力低下 | 偏相関分析で検証。ダメならストーリーを「空間的な生息適地判定」にピボット |

---

## 6. スケジュール感（ハッカソン残り期間に応じて調整）

| 優先度 | タスク | 工数目安 |
|---|---|---|
| **最優先** | 東北の目撃データ取得・統合 | 1日 |
| **最優先** | config.py更新 + JAXA再取得 | 半日 |
| **高** | EDA（東北版） | 1日 |
| **高** | メッシュ分割 + 特徴量テーブル生成 | 1日 |
| **高** | LightGBM学習 + 評価 | 1日 |
| **中** | FastAPI + 地図UI | 1〜2日 |
| **中** | 発表資料更新 | 半日 |
| **低** | 日次補正の実装 | 1日（余裕があれば） |
