# リスクヒートマップの生成方法（2025年推論の説明）

## 概要

リスクヒートマップは、JAXA衛星データで学習した空間リスクモデルの出力に、
実績ベースの季節係数と堅果類豊凶補正を掛け合わせることで生成しています。

```
統合リスク ＝ 空間リスク × 季節係数 × 堅果類豊凶補正
              (JAXA衛星)    (目撃実績)    (林業調査)
```

---

## Step 1: 空間リスク予測 — 「どこが危ないか」

秋田県全域を1km×1kmメッシュ（約6,400メッシュ）に分割し、
各メッシュに対してLightGBMモデルが「クマが出没しやすい場所か」を予測します。

### インプット（2025年に使用した入力値）

| 特徴量 | データソース | 2025年の値（例） |
|--------|------------|----------------|
| 緯度・経度 | メッシュ中心座標 | 例: 北緯39.99°, 東経140.40° |
| 標高 | JAXA AW3D30（ALOS衛星） | 例: 380m（山間部） |
| 森林フラグ | JAXA PALSAR-2 FNF（ALOS-2衛星） | 1（森林）or 0（非森林） |
| 月 | 予測対象月 | 1〜12 |

### モデル

- アルゴリズム: LightGBM（勾配ブースティング決定木）
- 学習データ: 2022〜2024年の目撃実績 + ネガティブサンプリング
- 性能: AUC 0.954（時系列分割: 2022-2024で学習、2025で検証）

### 教師データの構成

目撃の「有無」を二値分類（0/1）で学習しています。

| ラベル | 定義 | 件数比率 |
|--------|------|---------|
| **正例（target=1）** | あるメッシュ×ある月に実際にクマ目撃があった | 1 |
| **負例（target=0）** | 同じ月で目撃がなかったメッシュからランダム抽出 | 15（正例の15倍） |

1件でも目撃があればtarget=1、目撃件数の多寡は区別していません。
ネガティブサンプリングは目撃エリア周辺30km以内のメッシュに限定しており、
海上や遠方の都市部など明らかに出没しない場所を負例に含めないことで、
モデルが「位置だけで判別できる」過学習を防いでいます。

### アウトプット

各メッシュに0〜100%の空間リスクスコアが付与されます。
標高300〜600m帯の森林メッシュが高スコアになる傾向があります。

```
例: 10月のTOP1メッシュ（北秋田郡付近）
  → 空間リスク: 82.0%
```

---

## Step 2: 季節係数 — 「いつ危ないか」

過去の目撃データ（2022〜2024年、約16,000件）の月別分布から、
メッシュごとに「その月にどれだけ出没が集中するか」を算出します。

### 2025年に適用した季節係数（年間平均=1.0基準）

| 月 | 季節係数 | 意味 |
|----|---------|------|
| 1月 | ×0.11 | 冬眠中。出没はほぼない |
| 2月 | ×0.02 | 年間最低 |
| 3月 | ×0.03 | 冬眠末期 |
| 4月 | ×0.14 | 冬眠明け。活動開始 |
| 5月 | ×0.54 | 山菜採りシーズンで遭遇増 |
| 6月 | ×0.98 | 平均的な活動期 |
| 7月 | ×1.15 | やや活発 |
| 8月 | ×0.83 | 夏場は山中に留まる傾向 |
| 9月 | ×1.06 | 秋の活動開始 |
| **10月** | **×4.43** | **年間最大。冬眠前の食糧確保で人里に降りる** |
| 11月 | ×2.41 | 冬眠直前。依然高リスク |
| 12月 | ×0.31 | 冬眠入り |

10月の×4.43は、年間平均の4.4倍の出没リスクがあることを意味します。
これはJAXA衛星データではなく、過去の目撃実績のみから算出した値です。

### 算出方法と根拠

季節係数は**目撃データの統計的な集計**から算出しています。
LightGBMによる機械学習で最適化された値ではなく、
月別の目撃件数を数えて比率を出す単純な集計処理です。
手動で決めた仮置きの値でもありません。

| 要素 | 算出方法 | 性質 |
|------|---------|------|
| 空間リスク（Step 1） | LightGBMで学習 | 機械学習 |
| **季節係数（Step 2）** | **目撃件数の月別比率を集計** | **統計集計** |
| 堅果類補正（Step 3） | 手動で数式を設定 | 仮置き |

以下の手順で目撃データから計算しています。

**① グローバル季節パターンの算出**

2022〜2024年の全目撃データ（約16,000件）を月別に集計し、
12ヶ月の平均件数を1.0とした比率を算出します。

```
例: 10月の目撃件数が全月平均の4.43倍 → グローバル季節係数 = ×4.43
```

この値は目撃データの実分布をそのまま反映しており、
恣意的に設定した数値ではありません。

**② メッシュごとのローカル季節パターン**

グローバル係数は秋田県全体の平均ですが、メッシュ単位ではさらに
ローカルな季節パターンを計算しています。

各メッシュの周辺5km以内の目撃データをガウシアン重みで加重集計し、
「このメッシュ周辺ではどの月に出没が多いか」を算出します。

```
例: 10月TOP1メッシュの季節係数 = 7.36
  → 県平均(×4.43)よりさらに高い = この周辺は10月に特に集中的に出没
```

**③ グローバルとローカルのブレンド**

目撃データが少ないメッシュでは統計的に不安定なため、
近傍の累計目撃数に応じてグローバルパターンとブレンドします。

```
ブレンド比率 = min(近傍目撃数 / 50, 1.0)
最終係数 = ブレンド比率 × ローカル係数 + (1 - ブレンド比率) × グローバル係数
```

目撃数が50件以上の地域 → ローカルパターン100%、
50件未満の地域 → グローバルパターンに近づく、という設計です。

### 仮置きパラメータ

季節係数の値自体はデータから算出されますが、
計算過程に以下の手動設定パラメータが含まれます。

| パラメータ | 値 | 設定根拠 |
|-----------|-----|---------|
| 空間平滑化半径 | 5km | クマの一般的な行動圏（数km〜十数km）を参考に設定。厳密な最適化は未実施 |
| ブレンド閾値 | 50件 | 「統計的にまとまったパターンが見える最低件数」の目安として設定。統計的検定に基づく値ではない |
| 活動期下限クリップ | 0.3 | 4〜11月は最低×0.3（目撃が少ない月でもリスクゼロにしない安全マージン）。根拠は定性的 |

これらは今後、交差検証等で最適化する余地があります。

---

## Step 3: 堅果類豊凶補正 — 「凶作の年は危ない」

秋田県林業研究研修センター・東北森林管理局の調査データに基づき、
ブナ・ミズナラ等の堅果類（どんぐり）の作柄に応じたリスク補正を行います。

### 2025年のインプット

| 項目 | 値 |
|------|-----|
| ブナ着果指数 | 0.1（大凶作） |
| ミズナラ | 凶作 |
| 補正乗数 | **×1.50** |

凶作の年はクマが山中で食糧を確保できず人里に降りるため、出没リスクが増加します。
2025年は大凶作であるため、全メッシュのリスクを一律1.5倍に補正しています。

| 豊凶 | 補正乗数 | 効果 |
|------|---------|------|
| 豊作 | ×0.70 | リスク30%減 |
| 並作 | ×1.10 | リスク10%増 |
| 凶作 | ×1.30 | リスク30%増 |
| 大凶作 | ×1.50 | リスク50%増 |

### 補正乗数の根拠（仮置き）

`補正乗数 = 1.5 - score × 0.8` という計算式は、
**データから学習した値ではなく、経験的に手動設定した仮置きの値**です。

「凶作の年にクマ出没が増加する」という野生動物学の定性的知見に基づき、
大凶作で×1.5、豊作で×0.7という範囲を概算で設定し、線形補間しています。
過去の豊凶スコアと目撃件数の回帰分析による定量的検証は未実施です。

今後データが蓄積されれば、年別の豊凶スコアと目撃件数の関係を
回帰分析して最適な乗数に置き換えることが改善課題です。

---

## Step 4: 統合リスクの算出

3つの要素を掛け合わせて、最終的なリスクスコアを算出します。

### 10月TOP1メッシュの計算例

```
空間リスク:     82.0%  ← JAXA衛星データ（標高+森林）で予測
季節係数:       ×7.36  ← 過去の目撃実績から算出
堅果類補正:     ×1.50  ← 2025年大凶作

統合スコア = 82.0 × 7.36 × 1.50 = 905.6
```

統合スコアは99.5パーセンタイル値で0〜100%に正規化してヒートマップに表示します。
TOP10ランキングは正規化前のスコア（905.6等）で決定するため、
真にリスクの高いメッシュが正確に順位付けされます。

---

## Step 5: ヒートマップ可視化

### 事前推論とデータ埋め込み

Webアプリ（HTML）上ではモデルの推論を行っていません。
12ヶ月分のリスクデータはすべてPythonスクリプトで事前に推論し、
その結果をJSON形式（約1.3MB）でHTMLファイル内に直接埋め込んでいます。

```
[事前処理（Python）]
  generate_risk_map.py で 1月〜12月を一括推論
    ↓
  risk_data_2025.json（各月のヒートマップ座標・TOP10・目撃地点）
    ↓
  HTMLの <script> タグに var RISK_DATA = {...} として埋め込み

[ブラウザ表示時]
  スライダーで月を切り替え → 事前計算済みデータを読み替えて再描画
  → モデルの推論はブラウザ側では一切行わない
```

このためHTMLファイル単体でオフラインでも動作し、
サーバーやPython環境がなくてもブラウザだけでリスクマップを閲覧できます。

### 表示方法

- ベースマップ: OpenStreetMap
- ヒートマップ: Leaflet.js + leaflet-heat
  - 緑→黄→赤のグラデーションでリスクレベルを表現
- TOP10マーカー: 最もリスクの高い10メッシュを番号付きで表示
- 過去の目撃: 同月の過去の目撃地点を青ドットで表示（検証用）

### 月別スライダー

12ヶ月分の事前推論済みデータをスライダーで切り替え可能にしています。
これにより、季節によるリスク分布の変動を直感的に確認できます。

### 2025年の月別サマリ

| 月 | 高リスクメッシュ数 | 同月の過去目撃数 |
|----|-------------------|----------------|
| 2月 | 1 | 30件 |
| 4月 | 219 | 229件 |
| 7月 | 1,525 | 1,899件 |
| **10月** | **1,932** | **7,347件** |
| 11月 | 1,046 | 3,991件 |
| 12月 | 425 | 509件 |

10月は高リスクメッシュ数が年間最大の1,932メッシュ（約30%）に達し、
過去の同月目撃件数7,347件とも高い整合性を示しています。

---

## 各パラメータの影響度

### 空間リスクモデル（Step 1）の特徴量重要度

Baselineモデル（AUC 0.954）の各特徴量がモデル判断にどれだけ寄与しているかを示します。

| 特徴量 | 重要度(gain) | 寄与率 | データソース |
|--------|-------------|-------|------------|
| 経度（lon_center） | 75,889 | 38.2% | メッシュ座標 |
| **標高（elevation）** | **57,128** | **28.7%** | **JAXA AW3D30** |
| 緯度（lat_center） | 50,024 | 25.2% | メッシュ座標 |
| **森林フラグ（is_forest）** | **8,942** | **4.5%** | **JAXA PALSAR-2** |
| 月（month） | 6,787 | 3.4% | 入力パラメータ |

JAXA衛星データ（標高＋森林）で全体の**33.2%**を説明しています。
残りの63.4%は位置座標（緯度・経度）が占めており、
これは「秋田県内のどの地域か」という地理的パターンを学習していることを意味します。

特に**標高（28.7%）が単独で2番目に高い寄与率**を持ち、
AW3D30の標高データがクマ出没の空間パターン予測に大きく効いています。

### 季節係数（Step 2）の影響度

季節係数は空間リスクに掛け算で適用されるため、
その変動幅がそのままリスクスコアの変動幅に直結します。

| 月 | 季節係数 | 高リスクメッシュ数 | 効果 |
|----|---------|-------------------|------|
| 2月 | ×0.02 | 1 | 空間リスクを98%低減 |
| 4月 | ×0.14 | 219 | 空間リスクを86%低減 |
| 7月 | ×1.15 | 1,525 | ほぼ等倍 |
| **10月** | **×4.43** | **1,932** | **空間リスクを4.4倍に増幅** |
| 11月 | ×2.41 | 1,046 | 空間リスクを2.4倍に増幅 |
| 12月 | ×0.31 | 425 | 空間リスクを69%低減 |

2月（×0.02）と10月（×4.43）では**約221倍の差**があります。
これが同じ空間リスクのメッシュでも、月によってヒートマップの色が大きく変わる最大の要因です。

### 堅果類豊凶補正（Step 3）の影響度

| 年の豊凶 | 補正乗数 | 効果 |
|---------|---------|------|
| 豊作 | ×0.70 | 全メッシュのリスクを30%低減 |
| 並作 | ×1.10 | 微増（10%） |
| 大凶作（**2025年**） | **×1.50** | **全メッシュのリスクを50%増** |

豊作年と大凶作年の差は**2.1倍**です。
季節変動（221倍）に比べると控えめですが、「同じ10月でも、豊作年と大凶作年で
高リスク判定されるメッシュの数が大きく変わる」という年次間の差を表現しています。

### 3要素の総合的な影響度

```
  最低リスク条件:  2月 × 豊作    = ×0.02 × ×0.70 = ×0.014
  最高リスク条件:  10月 × 大凶作  = ×4.43 × ×1.50 = ×6.64

  → 条件の組み合わせで最大約475倍のリスク差が生まれる
```

2025年は大凶作（×1.50）であるため、10月のリスクは
空間リスクの**6.64倍**にまで増幅されます。
これにより、空間リスクが15%程度のメッシュでも
10月の統合リスクは15% × 6.64 = 99.6% → 高リスク判定となり、
ヒートマップ上で赤く表示されます。

---

## まとめ：JAXA衛星データの役割

| 処理段階 | JAXAデータの使用 | 説明 |
|---------|-----------------|------|
| 空間リスク予測 | **AW3D30（標高）** | クマが出没しやすい標高帯を特定 |
| 空間リスク予測 | **PALSAR-2 FNF（森林）** | 森林/非森林の分類で生息環境を判別 |
| 季節係数 | 不使用 | 目撃実績データのみから算出 |
| 堅果類補正 | 不使用 | 県林業調査データから適用 |

JAXA衛星データは「どこが危ないか」の空間的な予測を担い、
「いつ危ないか」は目撃実績と堅果類調査データが担うハイブリッド構成です。
