# データソース・パラメータ一覧

本プロジェクト（秋田県クマ出没リスク予測）で使用している全データと、
コード内で設定されているパラメータの根拠をまとめる。

---

## 1. JAXA衛星データ（JAXA Earth API経由）

取得スクリプト: `scripts/fetch_jaxa.py`
設定ファイル: `config.py` → `JAXA_COLLECTIONS`

### 1-1. AW3D30 標高（DEM）

| 項目 | 内容 |
|------|------|
| コレクション | `JAXA.EORC_ALOS.PRISM_AW3D30.v3.2_global` |
| バンド | `DSM` |
| 解像度 | ppu=120 → 約1km |
| 時系列 | なし（固定: 2021-02） |
| 用途 | 空間弁別（標高が高い山間部ほどクマ生息域） |
| 特徴量名 | `elevation` |

ALOS衛星のPRISM光学センサから生成された全球数値表層モデル。
30m解像度だが、API経由では1kmリサンプルで取得。標高は特徴量重要度でトップクラス。

### 1-2. PALSAR-2 森林・非森林マップ（FNF）

| 項目 | 内容 |
|------|------|
| コレクション | `JAXA.EORC_ALOS-2.PALSAR-2_FNF.v2.1.0_global_yearly` |
| バンド | `FNF` |
| 解像度 | ppu=120 → 約1km |
| 時系列 | なし（固定: 2020年） |
| 用途 | 空間弁別（森林=1 / 非森林=0 の二値分類） |
| 特徴量名 | `is_forest` |

ALOS-2衛星のPALSAR-2（Lバンド合成開口レーダー）による全球森林マップ。
雲の影響を受けないSARデータを使用しており、日本の森林被覆を高精度に分類。

### 1-3. MODIS NDVI（植生指数）月次

| 項目 | 内容 |
|------|------|
| コレクション | `JAXA.JASMES_Terra.MODIS-Aqua.MODIS_ndvi.v811_global_monthly` |
| バンド | `ndvi` |
| 解像度 | ppu=20 → 約5km |
| 時系列 | あり（2022-04 〜 2025-12 月次） |
| 用途 | 時間弁別（植生活性度の季節変動 → 食糧状況の代理指標） |
| 特徴量名 | `ndvi`, `ndvi_diff`, `ndvi_anomaly` |

Terra/Aqua衛星のMODISセンサによるNDVI月次プロダクト。
`ndvi_diff` は前月差分（植生の急変検知）、`ndvi_anomaly` は月別平年値との偏差（堅果類豊凶の代理指標）。

備考: GCOM-C SGLI NDVI（`JAXA.JASMES_GCOM-C.SGLI_standard.L2-NDVI.daytime.v3_japan_8-day`）はAPI上でも約5km（L3 1/24deg）で、MODISと同等解像度。250mネイティブデータはG-Portal直接DLのみ。当面MODISを使用。

### 1-4. MODIS LST（地表面温度）月次

| 項目 | 内容 |
|------|------|
| コレクション | `NASA.EOSDIS_Terra.MODIS_MOD11C3-LST.daytime.v061_global_monthly` |
| バンド | `LST` |
| 解像度 | ppu=20 → 約5km |
| 時系列 | あり（月次） |
| 用途 | 時間弁別（気温 → クマの活動パターン） |
| 特徴量名 | `lst_celsius`（ケルビン→摂氏変換済み） |
| 既知の問題 | **NaN率 62.3%**（雲被覆による欠損） |

Fullモデルに含まれているが、欠損率の高さからモデル精度を下げている可能性がある。
Baselineモデル（LSTなし）のAUC 0.954 > Fullモデル（LSTあり）のAUC 0.943。

### 1-5. GSMaP（降水量）月次

| 項目 | 内容 |
|------|------|
| コレクション | `JAXA.EORC_GSMaP_standard.Gauge.00Z-23Z.v6_monthly` |
| バンド | `PRECIP` |
| 解像度 | ppu=10 → 約10km |
| 時系列 | あり（月次） |
| 用途 | 時間弁別（降水量と行動の相関） |
| 特徴量名 | `precip` |

マイクロ波放射計と赤外データを統合した全球降水量プロダクト。地上雨量計による補正済み版（Gauge）。

### 1-6. Copernicus 土地被覆分類

| 項目 | 内容 |
|------|------|
| コレクション | `Copernicus.C3S_PROBA-V_LCCS_global_yearly` |
| バンド | `LCCS` |
| 解像度 | ppu=20 → 約5km |
| 時系列 | なし（固定: 2019年） |
| 用途 | 空間弁別補助（土地利用種別） |
| 特徴量名 | `landcover` |

ESA Copernicus Climate Change ServiceのLCCS分類。JAXAデータではないが、JAXA Earth API経由で取得可能。

### 1-7. MODIS NDVI 月次平年値

| 項目 | 内容 |
|------|------|
| コレクション | `JAXA.JASMES_Terra.MODIS-Aqua.MODIS_ndvi.v811_global_monthly-normal` |
| バンド | `ndvi_2012_2021` |
| 解像度 | ppu=20 → 約5km |
| 時系列 | なし（2012-2021の10年平均） |
| 用途 | NDVI偏差（`ndvi_anomaly`）算出のベースライン |

JAXA公式の月別平年値がない場合は、2022-2025データから自前で月別クリマトロジーを計算。

---

## 2. 非JAXAデータ

### 2-1. クマ目撃データ（秋田県クマダス）

| 項目 | 内容 |
|------|------|
| ファイル | `data/raw/sightings/akita_kumadas.csv` |
| 出力 | `data/raw/sightings/tohoku_sightings.csv` |
| ソース | 秋田県「クマダス」（クマ出没情報データベース） |
| 期間 | 2022年度〜（DATE_START: 2022-04-01） |
| 内容 | 日時・緯度経度・種別（目撃/痕跡/被害/捕獲）・市町村 |
| フィルタ | ツキノワグマのみ、BBOX内のみ |

正例（目撃あり）データとして使用。加工スクリプト: `scripts/prepare_sightings.py`

### 2-2. 堅果類豊凶データ

| 項目 | 内容 |
|------|------|
| ファイル | `data/raw/mast_production.csv` |
| ソース | 秋田県林業研究研修センター、東北森林管理局、秋田魁新報 |
| 期間 | 2002年〜2025年 |
| 内容 | 年次・ブナ着果指数(`buna_index`)・ブナ豊凶等級(`buna_grade`)・ミズナラ豊凶等級(`mizunara_grade`)・統合スコア(`score`) |

`score` は以下のように手動マッピングされている:

| buna_grade | score |
|------------|-------|
| 大凶作 | 0.0 |
| 凶作 | 0.25 |
| 並作 | 0.5 |
| 豊作 | 1.0 |

scoreの設計根拠: ブナ・ミズナラの豊凶等級を0-1の連続値に変換するための簡易マッピング。等間隔ではなく、大凶作と凶作を下位に寄せている。ただしこの変換は経験的なもので、実際の出没件数との定量的対応は未検証。

---

## 3. コード内で設定されているパラメータ

### 3-1. メッシュ設定

| パラメータ | 値 | コード位置 | 根拠 |
|-----------|-----|-----------|------|
| MESH_SIZE_KM | 1 | config.py | DEM/FNFの解像度（~1km）に合わせた。行政の防災対応単位としても実用的なサイズ |
| LAT_STEP | 1/111 度 | generate_risk_map.py, build_features.py | 赤道で緯度1度≈111km。日本（北緯40度付近）でもほぼ同じ |
| LON_STEP | 1/91 度 | 同上 | cos(40°)≈0.766、111km×0.766≈85-91km。北緯40度での経度1度あたりの距離 |
| BBOX_AKITA | [139.7, 39.0, 140.6, 40.5] | config.py | 秋田県の内陸山間部を包含する矩形。海岸平野部も含む |

### 3-2. ネガティブサンプリング

| パラメータ | 値 | コード位置 | 根拠 |
|-----------|-----|-----------|------|
| NEG_SAMPLE_RATIO | 15 | config.py | 正例1件に対して負例15件。正例率≈6.25%。クマ出没は稀な事象（全メッシュの数%のみ）であるため、この程度の不均衡が自然。過剰な比率はモデルの感度を下げるリスクがあるため15に設定 |
| BUFFER_DEG | 0.3度(≈30km) | build_features.py | 目撃エリアの周辺30kmバッファ内のメッシュのみを負例候補とする。遠方の明らかな非生息地（海上、都心部など）を負例に含めると、モデルが「位置だけで分類できる」ように学習してしまう過学習を防ぐため |
| random_state | 42 | build_features.py | 再現性のための固定シード。値自体に特別な根拠はない |

### 3-3. 季節係数

コード位置: `generate_risk_map.py` → `compute_seasonal_factors()`

| パラメータ | 値 | 根拠 |
|-----------|-----|------|
| sigma_km | 5.0 km | ガウシアン空間平滑化の標準偏差。1kmメッシュ単位では目撃件数が少ないため、周辺5km(3σ=15km)の目撃パターンを加重平均する。5kmはクマの一般的な行動圏（数km〜十数km）に対応 |
| data_weight閾値 | 50件 | `min(weighted_total_count / 50, 1.0)` で、近傍の累計目撃数が50件未満のメッシュはグローバル（秋田県全体）の季節パターンにブレンドされる。50は「統計的に十分な目撃パターン」の目安として設定。厳密な統計的検定に基づくものではない |
| 活動期最低係数 | 0.3 | 4-11月は`seasonal_factor`を0.3で下限クリップ。冬眠期（12-3月）以外は「最低でも通常の30%のリスクがある」とする仮定。根拠: クマの活動期は4月（冬眠明け）〜11月（冬眠入り）であり、目撃データが少ない月でも完全にゼロリスクにはしない安全側の設計 |
| 年間基準値 | 1.0 | 12ヶ月の平均を1.0として正規化。`global_monthly_ratio = total_by_month / total_by_month.mean()`。10月が約3.0（3倍）、2月が約0.1（1/10）のように変動する |

季節係数の計算ロジック:
1. 全目撃データから月別件数の比率を計算（グローバルパターン）
2. 各メッシュの周辺5km以内の目撃データから、そのメッシュ固有のローカルパターンを計算
3. ローカルデータが少ない（50件未満）メッシュはグローバルパターンにブレンド
4. これはJAXAデータではなく、目撃実績データのみから算出されている

### 3-4. 堅果類豊凶乗数

コード位置: `generate_risk_map.py` → `get_mast_multiplier()`

計算式: `multiplier = 1.5 - score × 0.8`

| score | buna_grade | multiplier | 意味 |
|-------|-----------|------------|------|
| 0.0 | 大凶作 | ×1.50 | リスク50%増 |
| 0.25 | 凶作 | ×1.30 | リスク30%増 |
| 0.5 | 並作 | ×1.10 | リスク10%増 |
| 1.0 | 豊作 | ×0.70 | リスク30%減 |

根拠と問題点:
- 背景: ブナ・ミズナラ等の堅果類（どんぐり）が凶作の年は、クマが山中で食糧を確保できず人里に降りるため出没が増加するという、野生動物学で広く知られた知見に基づく
- 乗数の範囲（0.7〜1.5）は、秋田県の年別目撃件数の変動幅から概算で設定したもの
- **線形仮定の問題**: 大凶作→凶作→並作→豊作の間でリスク変化が一定比率で推移するという仮定は未検証。実際は非線形（大凶作時に急増する可能性）の可能性がある
- **県単位の粗さ**: 秋田県全体に同一の乗数を適用しているが、実際は山林署管内単位で豊凶が異なる
- このパラメータはJAXAデータとは無関係で、経験的に設定されたもの

### 3-5. リスクスコア正規化

コード位置: `generate_risk_map.py` → `compute_combined_risk()`

```
raw_risk = spatial_risk × seasonal_factor × mast_multiplier
max_raw = raw_risk.quantile(0.995)
risk_score = clip(raw_risk / max(max_raw, 100) × 100, 0, 100)
```

| パラメータ | 値 | 根拠 |
|-----------|-----|------|
| 正規化分位点 | 99.5%ile | 上位0.5%を外れ値として扱い、それ以下を0-100にスケーリング。99%ileだと上位がやや潰れ、100%ileだと極端な外れ値に引きずられるため0.995を採用。経験的な選択 |

TOP10ランキングには正規化前の`raw_risk`を使用する（正規化後は同率100%が多数発生するため）。

### 3-6. LightGBMハイパーパラメータ

コード位置: `models/train.py`

| パラメータ | 値 | 根拠 |
|-----------|-----|------|
| objective | binary | 出没あり/なしの二値分類 |
| metric | auc | 不均衡データでの性能指標として標準的 |
| scale_pos_weight | 1.0 | ネガティブサンプリング（1:15）で不均衡を調整済みのため、二重補正を避ける |
| learning_rate | 0.05 | LightGBMの一般的な推奨範囲（0.01-0.1）の中間値 |
| num_leaves | 31 | LightGBMデフォルト値。データ量に対して適度な複雑度 |
| max_depth | 6 | 過学習防止。6-8が一般的なレンジ |
| min_child_samples | 10 | 葉ノードの最少サンプル数。デフォルトの20から緩和（データ量がやや少ないため） |
| subsample | 0.8 | 行サンプリング率。過学習防止の正則化 |
| colsample_bytree | 0.8 | 列サンプリング率。同上 |
| num_boost_round | 500 | 最大ブースティング回数 |
| early_stopping | 50 | 50ラウンド改善なしで停止 |

これらは機械学習のベストプラクティスに基づく標準的な値で、グリッドサーチ等の系統的なチューニングは未実施。

### 3-7. 閾値最適化

コード位置: `models/train.py` → `find_optimal_threshold()`

| パラメータ | 値 | 根拠 |
|-----------|-----|------|
| min_recall | 0.8 | Recall 80%以上を制約条件とし、その中でF1を最大化する閾値を自動選択。安全用途（クマ出没警告）では見逃し（FN）を最小化したいため、Precision（誤報率）よりもRecall（検知率）を優先 |

### 3-8. 表示用リスクレベル閾値

コード位置: `generate_risk_map.py` → `generate_folium_map()`

| total_multiplier | リスクレベル | 色 |
|-----------------|-------------|------|
| > 2.5 | 危険 | #d73027（赤） |
| > 1.5 | 警戒 | #fc8d59（オレンジ） |
| > 0.8 | 注意 | #fee08b（黄） |
| ≤ 0.8 | 低め | #91cf60（緑） |

ここでの `total_multiplier = seasonal_ratio × mast_multiplier`。
根拠: 経験的な設定。季節係数×堅果類補正の積が2.5を超えるのは、ピーク月（10月: ×3前後）かつ大凶作（×1.5）の組み合わせ程度であり、「危険」はごく限られた状況にのみ表示される設計。

---

## 4. モデル構成のまとめ

### 使用中のモデル: Baseline（AUC 0.954）

| 特徴量 | データソース | JAXAデータか |
|--------|------------|-------------|
| lat_center | メッシュ中心緯度 | いいえ（計算値） |
| lon_center | メッシュ中心経度 | いいえ（計算値） |
| elevation | AW3D30 | **はい** |
| is_forest | PALSAR-2 FNF | **はい** |
| month | 予測対象月 | いいえ（入力値） |

### Fullモデル（AUC 0.943、非採用）で追加される特徴量

| 特徴量 | データソース | JAXAデータか |
|--------|------------|-------------|
| ndvi | MODIS NDVI | はい（JAXA配信） |
| ndvi_diff | MODIS NDVI前月差分 | はい（JAXA配信） |
| ndvi_anomaly | MODIS NDVI偏差 | はい（JAXA配信） |
| lst_celsius | MODIS LST | いいえ（NASA、JAXA API経由） |
| precip | GSMaP | **はい** |
| landcover | Copernicus LCCS | いいえ（ESA、JAXA API経由） |
| mast_score | 堅果類豊凶データ | いいえ（県林業研究センター） |

### モデル外で適用される補正（JAXAデータ不使用）

| 補正 | 計算方法 | データソース |
|------|---------|------------|
| 季節係数 | 目撃実績の月別分布から算出 | クマダス目撃データ |
| 堅果類豊凶乗数 | `1.5 - score × 0.8` | 県林業研究センター等 |

### 最終出力の計算式

```
統合リスク = 空間リスク(Baselineモデル) × 季節係数(目撃実績) × 堅果類乗数(豊凶データ)
```

JAXAデータが直接使われているのは空間リスク予測（DEM + FNF）のみ。
季節係数と堅果類乗数はJAXAデータとは独立した経験的パラメータである。
